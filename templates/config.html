{% extends "base.html" %}

{% block title %}GPUè°ƒåº¦ç³»ç»Ÿ - ç³»ç»Ÿé…ç½®{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-gear"></i> ç³»ç»Ÿé…ç½®</h2>
        <p class="text-muted">é…ç½®è°ƒåº¦å™¨çš„æ£€æŸ¥é—´éš”æ—¶é—´</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock"></i> æ£€æŸ¥é—´éš”é…ç½®
                </h5>
            </div>
            <div class="card-body">
                <form id="config-form">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="retry-interval" class="form-label">é‡è¯•é—´éš”ï¼ˆç§’ï¼‰</label>
                                <input type="number" class="form-control" id="retry-interval" 
                                       min="1" max="300" value="5" required>
                                <div class="form-text">
                                    å½“ä»»åŠ¡ä¸æ»¡è¶³æ‰§è¡Œæ¡ä»¶æ—¶ï¼Œç­‰å¾…å¤šå°‘ç§’åé‡æ–°æ£€æŸ¥
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="idle-interval" class="form-label">ç©ºé—²é—´éš”ï¼ˆç§’ï¼‰</label>
                                <input type="number" class="form-control" id="idle-interval" 
                                       min="1" max="60" value="1" required>
                                <div class="form-text">
                                    å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œç­‰å¾…å¤šå°‘ç§’åæ£€æŸ¥æ–°ä»»åŠ¡
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="error-interval" class="form-label">é”™è¯¯é—´éš”ï¼ˆç§’ï¼‰</label>
                                <input type="number" class="form-control" id="error-interval" 
                                       min="1" max="300" value="5" required>
                                <div class="form-text">
                                    å‘ç”Ÿé”™è¯¯æ—¶ï¼Œç­‰å¾…å¤šå°‘ç§’åç»§ç»­è¿è¡Œ
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> ä¿å­˜é…ç½®
                    </button>
                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="loadConfig()">
                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°é…ç½®
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> é…ç½®è¯´æ˜
                </h5>
            </div>
            <div class="card-body">
                <h6>é‡è¯•é—´éš”</h6>
                <p class="text-muted small">
                    å½“ä»»åŠ¡éœ€è¦GPUä½†å½“å‰GPUä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿä¼šç­‰å¾…è¿™ä¸ªæ—¶é—´åé‡æ–°æ£€æŸ¥GPUå¯ç”¨æ€§ã€‚
                </p>
                
                <h6>ç©ºé—²é—´éš”</h6>
                <p class="text-muted small">
                    å½“æ²¡æœ‰ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­æ—¶ï¼Œç³»ç»Ÿä¼šç­‰å¾…è¿™ä¸ªæ—¶é—´åæ£€æŸ¥æ˜¯å¦æœ‰æ–°ä»»åŠ¡æäº¤ã€‚
                </p>
                
                <h6>é”™è¯¯é—´éš”</h6>
                <p class="text-muted small">
                    å½“è°ƒåº¦å™¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œç³»ç»Ÿä¼šç­‰å¾…è¿™ä¸ªæ—¶é—´åç»§ç»­è¿è¡Œï¼Œé¿å…é¢‘ç¹é‡è¯•ã€‚
                </p>
                
                <hr>
                
                <h6>æ¨èé…ç½®</h6>
                <ul class="list-unstyled small">
                    <li><strong>å¿«é€Ÿå“åº”</strong>: é‡è¯•1-3ç§’ï¼Œç©ºé—²1ç§’</li>
                    <li><strong>å¹³è¡¡æ¨¡å¼</strong>: é‡è¯•5-10ç§’ï¼Œç©ºé—²1-2ç§’</li>
                    <li><strong>èŠ‚èƒ½æ¨¡å¼</strong>: é‡è¯•10-30ç§’ï¼Œç©ºé—²5-10ç§’</li>
                </ul>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i> å½“å‰çŠ¶æ€
                </h5>
            </div>
            <div class="card-body">
                <div id="current-config">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é…ç½®è¯´æ˜ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightbulb"></i> é…ç½®å»ºè®®
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>ğŸ”„ é‡è¯•é—´éš”</h6>
                        <ul class="small">
                            <li><strong>1-3ç§’</strong>: é€‚åˆGPUèµ„æºç´§å¼ çš„ç¯å¢ƒ</li>
                            <li><strong>5-10ç§’</strong>: å¹³è¡¡æ€§èƒ½å’Œèµ„æºæ¶ˆè€—</li>
                            <li><strong>10-30ç§’</strong>: é€‚åˆGPUèµ„æºå……è¶³çš„ç¯å¢ƒ</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6>â° ç©ºé—²é—´éš”</h6>
                        <ul class="small">
                            <li><strong>1ç§’</strong>: å¿«é€Ÿå“åº”æ–°ä»»åŠ¡</li>
                            <li><strong>2-5ç§’</strong>: å¹³è¡¡å“åº”é€Ÿåº¦å’ŒCPUä½¿ç”¨</li>
                            <li><strong>5-10ç§’</strong>: å‡å°‘CPUä½¿ç”¨ï¼Œé€‚åˆä½è´Ÿè½½ç¯å¢ƒ</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6>âš ï¸ é”™è¯¯é—´éš”</h6>
                        <ul class="small">
                            <li><strong>5ç§’</strong>: å¿«é€Ÿæ¢å¤</li>
                            <li><strong>10-30ç§’</strong>: é¿å…é¢‘ç¹é‡è¯•</li>
                            <li><strong>30-60ç§’</strong>: ç­‰å¾…é—®é¢˜è§£å†³</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function loadConfig() {
    axios.get('/api/config')
        .then(response => {
            const config = response.data;
            
            document.getElementById('retry-interval').value = config.retry_interval;
            document.getElementById('idle-interval').value = config.idle_interval;
            document.getElementById('error-interval').value = config.error_interval;
            
            updateCurrentConfig(config);
        })
        .catch(error => {
            console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            alert('åŠ è½½é…ç½®å¤±è´¥: ' + error.response?.data?.error || error.message);
        });
}

function updateCurrentConfig(config) {
    const container = document.getElementById('current-config');
    container.innerHTML = `
        <div class="row text-center">
            <div class="col-4">
                <h6 class="text-primary">${config.retry_interval}s</h6>
                <small class="text-muted">é‡è¯•é—´éš”</small>
            </div>
            <div class="col-4">
                <h6 class="text-success">${config.idle_interval}s</h6>
                <small class="text-muted">ç©ºé—²é—´éš”</small>
            </div>
            <div class="col-4">
                <h6 class="text-warning">${config.error_interval}s</h6>
                <small class="text-muted">é”™è¯¯é—´éš”</small>
            </div>
        </div>
        <hr>
        <div class="text-center">
            <small class="text-muted">
                <i class="bi bi-clock"></i> 
                æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')}
            </small>
        </div>
    `;
}

// æäº¤é…ç½®è¡¨å•
document.getElementById('config-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const retryInterval = parseInt(document.getElementById('retry-interval').value);
    const idleInterval = parseInt(document.getElementById('idle-interval').value);
    const errorInterval = parseInt(document.getElementById('error-interval').value);
    
    // éªŒè¯è¾“å…¥
    if (retryInterval < 1 || idleInterval < 1 || errorInterval < 1) {
        alert('æ‰€æœ‰é—´éš”æ—¶é—´å¿…é¡»æ˜¯æ­£æ•´æ•°');
        return;
    }
    
    axios.post('/api/config', {
        retry_interval: retryInterval,
        idle_interval: idleInterval,
        error_interval: errorInterval
    })
    .then(response => {
        alert('é…ç½®å·²ä¿å­˜ï¼');
        updateCurrentConfig(response.data);
    })
    .catch(error => {
        alert('ä¿å­˜é…ç½®å¤±è´¥: ' + error.response?.data?.error || error.message);
    });
});

// é¡µé¢åŠ è½½æ—¶è·å–é…ç½®
document.addEventListener('DOMContentLoaded', function() {
    loadConfig();
});
</script>
{% endblock %} 